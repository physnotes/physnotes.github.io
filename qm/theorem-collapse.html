<script>
(() => {
  const KINDS = ["example","remark"]; // only these become collapsible

  function findTitleNode(box, kind) {
    // Prefer exact "<kind>-title"
    let t = box.querySelector(`.${kind}-title`);
    if (t) return t;

    // Any "*-title"
    t = box.querySelector('[class$="-title"]');
    if (t) return t;

    // Fallbacks: first heading, then strong/span at the top
    const first = box.firstElementChild;
    if (first && /^H[1-6]$/i.test(first.tagName)) return first;
    return box.querySelector("strong, h1, h2, h3, h4, h5, h6, span");
  }

  function convertBox(box, kind) {
    if (box.dataset.detailsConverted) return;

    const title = findTitleNode(box, kind);
    if (!title) return;

    // Build <details> skeleton and carry over id/classes
    const det = document.createElement("details");
    det.open = true; // default open; set to false if you want collapsed by default
    det.className = box.className; // keeps .example/.remark and any other classes
    if (box.id) det.id = box.id;

    const sum = document.createElement("summary");
    // Ensure a consistent class so CSS can target it
    sum.classList.add(`${kind}-title`);

    // Move title content into <summary>; remove the old node (but keep its siblings)
    sum.innerHTML = title.innerHTML;
    title.remove();

    // Move all remaining child nodes into a body container
    const body = document.createElement("div");
    body.className = "details-body";
    while (box.firstChild) body.appendChild(box.firstChild);

    det.appendChild(sum);
    det.appendChild(body);

    // Replace the original box in the DOM
    box.replaceWith(det);

    // Mark done
    det.dataset.detailsConverted = "1";
  }

  function processAll(root = document) {
    KINDS.forEach(kind => {
      root.querySelectorAll(`.${kind}`).forEach(box => convertBox(box, kind));
    });
  }

  // Initial pass
  document.addEventListener("DOMContentLoaded", () => processAll());

  // Safety pass after everything (e.g., math typesetting)
  window.addEventListener("load", () => processAll());

  // Watch for late-added boxes (rare but safe)
  const obs = new MutationObserver(muts => {
    muts.forEach(m => {
      m.addedNodes.forEach(node => {
        if (!(node instanceof Element)) return;
        if (KINDS.some(k => node.classList?.contains(k))) processAll(node);
        else node.querySelectorAll?.(".example, .remark").forEach(el => processAll(el));
      });
    });
  });
  obs.observe(document.body, { childList: true, subtree: true });
})();
</script>
